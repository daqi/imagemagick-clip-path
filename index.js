/**
 * 先要安装 imagemagick
 * https://imagemagick.org/script/download.php
 */

const exec = require("child_process").exec;

function myExec(cmd) {
  return new Promise((rs, rj) => {
    exec(cmd, function(error, stdout, stderr) {
      if (error) {
        rj(error);
      }
      // console.log(stdout, stderr);
      rs(stdout);
    });
  });
}

const width = 1928;
const height = 1524;

const path1 =
  "M376.2,2l39.3,1.5c0,0-7.6,75.9,15,88.5c14.7,8.2,33,2.4,47.5,0.2c12.7-1.9,28.1-3.9,28.1-3.9 s0.1,85.6,68.2,188.8c76.9,116.5,206.4,224.3,411.5,215.3c149.1-6.5,253.1-70.9,324.8-155.7c33.9-40,60-83.5,78.1-121.9 c34.8-73.7,36.1-125.8,36.1-125.8s17.6,2.7,34.4,5c18.1,2.4,31.9,7.4,45.4-5.5c8.9-8.4,10.3-24.5,11.1-42.2 c0.9-20.6,0.3-42.7,0.3-42.7l39.3-1.3c0,0,3.8,93.3-7.2,143.2c-18.1,81.6-55.4,184.3-141,274.3c-29.8,31.3-58,61.6-92.1,88.2 c-41.2,32.2-89.2,59.3-134.5,76.7c-70.2,26.9-163.3,37.6-217.2,35.7c-34.7-1.3-62-0.3-91.2-4.7c-91.5-13.7-167.9-43.8-231-89 c-41.1-29.4-69.1-55.4-102.4-90.5c-31.1-32.9-68-74.4-93.5-122.5c-19.8-37.3-36.3-74.2-47.3-111.2C366,96.4,376.2,2,376.2,2z";
const path2 =
  "M1928.8,692.8l0.5-13.3l-69.8-3.4l-40.1-1.9l-41.8-2l-41.1-1.8l-40-1.7l-38.5-1.6l-35.6-1.4 l-31-1.1l-27.4-1l-24.6-0.8l-26-0.8l-31.7-1l-32-0.9l-17.9-0.5l-21.8-0.7l-34.5-1l-39.9-1l-38.5-1l-40.4-0.9l-46.1-0.9l-45-0.8 l-37.4-0.5l-31.1-0.2l-25.6-0.1l-22.6-0.2l-21.7-0.2l-21.1-0.2l-20.6,0l-20.5,0l-20.5,0l-20.6,0l-21,0.1l-21.7,0.2l-22.6,0.2 l-25.6,0.1l-31.1,0.2l-37.4,0.5l-45,0.8l-46.1,0.9l-40.4,0.9l-38.5,1l-39.9,1l-34.5,0.9l-21.7,0.7l-17.9,0.5l-32,0.9l-31.7,1 l-26,0.8l-24.6,0.8l-27.4,1l-31,1.1l-35.6,1.4l-38.5,1.6l-40,1.7l-41.1,1.8l-41.8,1.9L71,676l-69.8,3.4l0.5,13.3l1.1,32.7l1,32 l1,29.5l1.4,36.9l1.2,34.7l1.2,35l1.3,36.3l1.3,37.5l1.4,38.7l1.5,40.5l1.6,42.9l1.6,45.1l1.7,47.1l1.8,48.7l1.8,49.9l1.9,51.5 l2,53.5l1.9,51.5l1.7,45.6l1.6,42.7l35.5-1.8l36.4-2.1l38.4-2.6l39.4-2.3l39.4-1.3l36.1-0.8l29.4-0.9l27.2-1l29.4-1.1l30.5-1.1 l30.5-1l31.3-1l33-1l36.3-1.1l41.4-1.2l45-1.2l47.4-1.2l47.8-1l46.6-0.8l48.5-0.7l53.9-0.5l51.8-0.2l41.6,0l36.7,0l36.7,0l41.6,0 l51.8,0.2l53.9,0.5l48.5,0.7l46.6,0.8l47.8,1.1l47.4,1.2l45,1.2l41.4,1.2l36.3,1.1l33,1l31.3,1l30.5,1.1l30.5,1.1l29.4,1.1l27.2,1 l29.4,1l36.1,0.8l39.4,1.3l39.4,2.3l38.4,2.6l36.4,2.1l35.5,1.8l1.6-42.7l1.7-45.6l1.9-51.5l2-53.5l1.9-51.5l1.8-49.9l1.8-48.7 l1.7-47.1l1.7-45.1l1.6-42.9l1.5-40.5l1.4-38.7l1.3-37.5l1.3-36.3l1.2-35l1.2-34.7l1.4-36.9l1-29.5l1-32l0.8-24.4L1928.8,692.8 l0.5-13.3  M902.8,757L875.6 757.1 858.2 757.3 851.8 757.9 845.7 759.6 840 762.5 834.9 766.2 830.6 770.9 827.2 776.4 825.1 782.5 824.3 789 824.4 792.8 825 813.1 826.7 827 830.6 839.5 831.7 841.6 835.8 848.2 840.4 853.4 845.1 857.5 849.6 860.5 860.9 865.6 872.1 867.9 894.3 868.6 900.5 868.6 901.3 868.6 902 868.6 902.7 868.3 934.4 868.4 965.6 868.3 965.6 868.3 965.6 868.3 966.4 868.3 967.1 868.3 967.8 868.3 972.5 868.2 994.1 868.1 1015.7 868 1028.5 868 1031.3 867.9 1034 867.9 1036.8 867.9 1052.7 867.5 1062.5 866.3 1072.1 863.7 1078.3 860.9 1084.5 857 1090 852.4 1094.8 847 1098.8 841 1103.2 829 1105 816.7 1106.1 791.7 1106.1 787.6 1105.3 781.1 1103.1 775 1099.7 769.5 1095.3 764.9 1090.2 761.2 1084.5 758.5 1078.3 756.8 1071.9 756.2 1054.3 756.2 1027.3 756.3 998.8 756.4 965.1 756.6 935.3 756.8 902.8 757";
const path3 =
  "M978.3,1016.1L965.5 1016.2 952.7 1016.3 944.6 1015.6 936.8 1013.4 929.6 1009.9 923.1 1005.1 917.5 999.2 913.2 992.4 910.2 984.9 908.6 977 908.4 972.7 908.3 947.2 909.1 938.6 911.6 930.4 915.7 922.8 921.1 916.2 927.8 910.7 935.4 906.6 943.6 904.1 952.1 903.2 964.9 903.2 977.7 903.1 986.3 903.9 994.5 906.3 1002.1 910.3 1008.8 915.7 1014.4 922.3 1018.5 929.9 1021.1 938.1 1022 946.6 1022.2 972.2 1022.1 975.4 1020.7 983.5 1017.9 991.2 1013.7 998.2 1008.2 1004.3 1001.7 1009.3 994.4 1013 986.5 1015.3 z";

async function gen(imagePath, w, h, x, y) {
  const d = "|||";
  console.log("start flow");
  const res = await myExec(`identify -format "%[colorspace]" ${imagePath}`);
  const resArr = res.split(d);
  const [colorspace] = resArr;
  const wh = `${width}x${height}`;
  console.log("init path");
  await myExec(
    `convert -size ${wh} xc:black -fill white -stroke black -draw "path '${path1} ${path2} ${path3}'" path.gif`
  );
  if (w) {
    console.log("crop");
    await myExec(`convert -crop ${w}x${h}+${x}+${y}\! ${imagePath} croped.jpg`);
  } else {
    await myExec(`cp ${imagePath} croped.jpg`);
  }
  console.log("resize");
  await myExec(
    `convert -colorspace sRGB -resize ${wh}^ -gravity center -extent ${wh} croped.jpg resized.jpg`
  );
  console.log("clip by path");
  await myExec(
    `convert resized.jpg path.gif -alpha off -compose CopyOpacity -composite +compose res.png`
  );
  console.log("format");
  await myExec(`convert res.png -alpha remove -alpha off res.jpg`);
  await myExec(`convert -colorspace ${colorspace} res.jpg res.jpg`);
  console.log("finished");
}

const imgPath1 = "1928x1524-72dpi.jpg";
const imgPath2 = "1928x1524-300dpi.jpg";
const imgPath3 = "WechatIMG149.jpg";

const current = imgPath3;

gen(current);

// myExec("convert -size 1928x1524 cur.svg res.png");
// myExec("rsvg-convert cur.svg -o res.png");
